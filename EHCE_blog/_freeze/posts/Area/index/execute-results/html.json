{
  "hash": "7fb0bf21640edd7b4e170965b508f260",
  "result": {
    "markdown": "---\ntitle: \"EHCE Area Trend Analysis\"\nauthor: \"Jingya Cheng\"\ndate: \"2024-01-05\"\ncategories: [code, analysis, trend]\n---\n\n\n# Extreme Heat/Cold Events Area Trend Analysis\n\n\n\n\n\n### Loading the base spatail data set including Counties and States boundaires\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource_dir <- \"./data/\"\nstates_file_path <- file.path(source_dir,\n                              \"us49_states_geo_tigris.rds\")\nstates_geo <- readRDS(states_file_path)[[1]]\ncounties_file_path <- file.path(source_dir,\n                                \"us49_counties_geo_tigris.rds\")\ncounties_geo <- readRDS(counties_file_path)[[1]]\n```\n:::\n\n\n### Loading the aggregate extreme events data set\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_path <- file.path(source_dir,\n                      \"Counties_compiled_admin_geo_ehe_ece_sf_2008_2022.rds\")\nfile_size <- file.info(dat_path)$size\ndat <- readRDS(dat_path)[[1]]\n```\n:::\n\n\n### Calculating the average area with complete yearly area records\n\n#### Overall area\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat_table = dat %>%  st_drop_geometry()\n## Adding years with no event to the dataset \nlookup_table <- dat_table %>%\n  select(GEOID, NAME, STUSPS, STATE_NAME) %>%\n  distinct() %>%\n  filter(!is.na(NAME) & !is.na(STUSPS) & !is.na(STATE_NAME))\n\nfill_na_with_lookup <- function(dat_table, lookup_table, column) {\n  na_rows <- is.na(dat_table[[column]])\n  lookup_values <- lookup_table[match(dat_table$GEOID[na_rows], lookup_table$GEOID), column]\n  dat_table[[column]][na_rows] <- lookup_values\n  return(dat_table)\n}\nyear_range <- data.frame(year_numerical = 2008:2022)\nunique_geoids <- unique(dat$GEOID)\nyear_geoid_combinations <- expand.grid(year_numerical = year_range$year_numerical, GEOID = unique_geoids)\n\n## Overall\ncounty_yearly_area_hectare <- dat_table %>%\n  group_by(GEOID,NAME, STATE_NAME, year_numerical) %>%\n  summarize(avg_impacted_to_total_ratio = mean(impacted_to_total_ratio))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'GEOID', 'NAME', 'STATE_NAME'. You can\noverride using the `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\ndat_area_all <- merge(year_geoid_combinations, county_yearly_area_hectare, by = c(\"year_numerical\", \"GEOID\"), all = TRUE)\ndat_area_all[\"avg_impacted_to_total_ratio\"] <- lapply(dat_area_all[\"avg_impacted_to_total_ratio\"], function(x) ifelse(is.na(x), 0, x))\ndat_area_all <- fill_na_with_lookup(dat_area_all, \n                                               lookup_table, \"NAME\")\ndat_area_all <- fill_na_with_lookup(dat_area_all, \n                                               lookup_table, \"STATE_NAME\")\n\n#linear regression and calcualte percentage change\nlm_area_all <- dat_area_all %>%\n  group_by(GEOID, NAME, STATE_NAME) %>%\n  do(model = lm(avg_impacted_to_total_ratio~ year_numerical, data = .))\n\nslopes_all <- lm_area_all %>%\n  rowwise() %>%\n  mutate(slope = coef(model)[[\"year_numerical\"]],\n         p_value = summary(model)$coefficients[\"year_numerical\",\"Pr(>|t|)\"],\n         r_squared = glance(model)$r.squared)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: There were 3 warnings in `mutate()`.\nThe first warning was:\nℹ In argument: `p_value = summary(model)$coefficients[\"year_numerical\",\n  \"Pr(>|t|)\"]`.\nℹ In row 2810.\nCaused by warning in `summary.lm()`:\n! essentially perfect fit: summary may be unreliable\nℹ Run `dplyr::last_dplyr_warnings()` to see the 2 remaining warnings.\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(slopes_all$p_value)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_all$slope)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_all$r_squared)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n:::\n\n\n#### Map\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#slopes_cut = slopes_all %>% filter(!(p_value > 0.5))\n# Merge with geometry data\ncounty_boundaris_catalog_all <- merge(counties_geo,\n          slopes_all %>% st_drop_geometry(),\n          by.x=\"GEOID\",\n          by.y=\"GEOID\",\n          all.x = TRUE,\n          all.y = TRUE,\n          suffix = c(\"\",\"_sp\")) %>% st_as_sf() \n# area all map\nggplot() +\n  geom_sf(data = county_boundaris_catalog_all,\n            aes(fill = slope), color = NA,\n            lwd = .1) + \n  scale_fill_distiller(palette = \"RdBu\", \n                       limits = c(-0.065, 0.065),\n                       breaks = c(-0.05, 0, 0.05),\n                       ) +\n  geom_sf(data = states_geo, fill = NA, color = \"grey\", size = 0.01, alpha = 0.2) +\n  labs(fill = \"Area\") +\n  theme_void() + \n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n#### Extreme Heat Events\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_ehe_area_hectare <- dat_table %>%\n  filter(event_type == \"Extreme Heat Event\") %>%\n  group_by(GEOID,NAME, STATE_NAME, year_numerical) %>%\n  summarize(avg_impacted_to_total_ratio = mean(impacted_to_total_ratio))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'GEOID', 'NAME', 'STATE_NAME'. You can\noverride using the `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\ndat_area_ehe <- merge(year_geoid_combinations, county_ehe_area_hectare, by = c(\"year_numerical\", \"GEOID\"), all = TRUE)\ndat_area_ehe[\"avg_impacted_to_total_ratio\"] <- lapply(dat_area_ehe[\"avg_impacted_to_total_ratio\"], function(x) ifelse(is.na(x), 0, x))\ndat_area_ehe <- fill_na_with_lookup(dat_area_ehe, \n                                               lookup_table, \"NAME\")\ndat_area_ehe <- fill_na_with_lookup(dat_area_ehe, \n                                               lookup_table, \"STATE_NAME\")\n\n#linear regression and calcualte percentage change\nlm_area_ehe <- dat_area_ehe %>%\n  group_by(GEOID, NAME, STATE_NAME) %>%\n  do(model = lm(avg_impacted_to_total_ratio ~ year_numerical, data = .))\n\nslopes_ehe <- lm_area_ehe %>%\n  rowwise() %>%\n  mutate(slope = coef(model)[[\"year_numerical\"]],\n         p_value = summary(model)$coefficients[\"year_numerical\",\"Pr(>|t|)\"],\n         r_squared = glance(model)$r.squared)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(slopes_ehe$p_value)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_ehe$slope)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_ehe$r_squared)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-3.png){width=672}\n:::\n:::\n\n\n#### Map\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#slopes_ehe_cut = slopes_ehe %>% filter(p_value < 0.05)\n# Merge with geometry data\ncounty_boundaris_ehe_catalog <- merge(counties_geo,\n          slopes_ehe %>% st_drop_geometry(),\n          by.x=\"GEOID\",\n          by.y=\"GEOID\",\n          all.x = TRUE,\n          all.y = TRUE,\n          suffix = c(\"\",\"_sp\")) %>% st_as_sf() \n# Area EHE map\nggplot() +\n  geom_sf(data = county_boundaris_ehe_catalog,\n            aes(fill = slope),color = NA,\n            lwd = .1) + \n  scale_fill_distiller(palette = \"RdBu\", \n                       limits = c(-0.085, 0.085)\n                       ) +\n  geom_sf(data = states_geo, fill = NA, color = \"grey\", size = 0.5) +\n  labs(fill = \"Area EHE\") +\n  theme_void() + \n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n#### Extreme Cold Events\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_ece_area_hectare <- dat_table %>%\n  filter(event_type == \"Extreme Cold Event\") %>%\n  group_by(GEOID,NAME, STATE_NAME, year_numerical) %>%\n  summarize(avg_impacted_to_total_ratio = mean(impacted_to_total_ratio))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'GEOID', 'NAME', 'STATE_NAME'. You can\noverride using the `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\ndat_area_ece <- merge(year_geoid_combinations, county_ece_area_hectare, by = c(\"year_numerical\", \"GEOID\"), all = TRUE)\ndat_area_ece[\"avg_impacted_to_total_ratio\"] <- lapply(dat_area_ece[\"avg_impacted_to_total_ratio\"], function(x) ifelse(is.na(x), 0, x))\ndat_area_ece <- fill_na_with_lookup(dat_area_ece, \n                                               lookup_table, \"NAME\")\ndat_area_ece <- fill_na_with_lookup(dat_area_ece, \n                                               lookup_table, \"STATE_NAME\")\n\n#linear regression and calcualte percentage change\nlm_area_ece <- dat_area_ece %>%\n  group_by(GEOID, NAME, STATE_NAME) %>%\n  do(model = lm(avg_impacted_to_total_ratio ~ year_numerical, data = .))\n\nslopes_ece <- lm_area_ece %>%\n  rowwise() %>%\n  mutate(slope = coef(model)[[\"year_numerical\"]],\n         p_value = summary(model)$coefficients[\"year_numerical\",\"Pr(>|t|)\"],\n         r_squared = glance(model)$r.squared)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhist(slopes_ece$p_value)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_ece$slope)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n\n```{.r .cell-code}\nhist(slopes_ece$r_squared)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-3.png){width=672}\n:::\n:::\n\n\n#### Map\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#slopes_ece_cut = slopes_ece %>% filter(p_value < 0.05)\n# Merge with geometry data\ncounty_boundaris_ece_catalog <- merge(counties_geo,\n          slopes_ece %>% st_drop_geometry(),\n          by.x=\"GEOID\",\n          by.y=\"GEOID\",\n          all.x = TRUE,\n          all.y = TRUE,\n          suffix = c(\"\",\"_sp\")) %>% st_as_sf() \n# Area ECE map\nggplot() +\n  geom_sf(data = county_boundaris_ece_catalog,\n            aes(fill = slope), color = NA,\n            lwd = .1) + \n  scale_fill_distiller(palette = \"RdBu\", \n                       limits = c(-0.071, 0.071)\n                       ) +\n  geom_sf(data = states_geo, fill = NA, color = \"grey\", size = 0.5) +\n  labs(fill = \"Area ECE\") +\n  theme_void() + \n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}